name: Auto-Merge Claude Feature Branches

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: startsWith(github.head_ref, 'claude/')
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Check if PR is mergeable
        id: check-merge
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          # Get PR mergeable status
          MERGEABLE=$(gh pr view $PR_NUMBER --json mergeable --jq '.mergeable')
          echo "mergeable_status=$MERGEABLE" >> $GITHUB_OUTPUT

          if [ "$MERGEABLE" = "CONFLICTING" ]; then
            echo "üö® PR has merge conflicts - waiting for auto-resolution workflow..."
            exit 0
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-merge PR when ready
        if: steps.check-merge.outputs.mergeable_status != 'CONFLICTING'
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}

          # Try to merge with squash strategy
          if gh pr merge $PR_NUMBER --squash --delete-branch; then
            echo "‚úì Successfully merged PR #$PR_NUMBER"
          else
            echo "‚ö†Ô∏è Merge not yet possible - waiting for status checks or conflict resolution"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Report merge status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const mergeable = '${{ steps.check-merge.outputs.mergeable_status }}';

            if (mergeable === 'CONFLICTING') {
              console.log('‚è≥ PR has conflicts - auto-resolution workflow is handling this');
            } else if (mergeable === 'MERGEABLE') {
              console.log('‚úÖ PR is mergeable');
            } else {
              console.log('‚è≥ PR is not yet ready to merge - waiting for status checks');
            }
