name: Validate Repository Configuration

on:
  workflow_dispatch:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Validate repository settings
        id: validate
        run: |
          echo "Validating repository configuration..."

          # Get repository settings
          REPO_SETTINGS=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}")

          # Check auto-delete branch setting
          AUTO_DELETE=$(echo "$REPO_SETTINGS" | jq -r '.delete_branch_on_merge')

          # Check if PRs are enabled
          HAS_ISSUES=$(echo "$REPO_SETTINGS" | jq -r '.has_issues')

          # Check default branch
          DEFAULT_BRANCH=$(echo "$REPO_SETTINGS" | jq -r '.default_branch')

          echo "Repository Configuration:"
          echo "========================"
          echo "Auto-delete branches on merge: $AUTO_DELETE"
          echo "Issues enabled: $HAS_ISSUES"
          echo "Default branch: $DEFAULT_BRANCH"

          # Validation results
          VALIDATION_FAILED=0
          WARNINGS=""

          # Critical: Check auto-delete branch setting
          if [ "$AUTO_DELETE" = "true" ]; then
            WARNINGS="${WARNINGS}\n‚ö†Ô∏è **CRITICAL**: Auto-delete branch on merge is ENABLED in repository settings"
            WARNINGS="${WARNINGS}\n   - This conflicts with Claude Code web interface session tracking"
            WARNINGS="${WARNINGS}\n   - Sessions will appear as 'Session ended' instead of showing 'Merged' status"
            WARNINGS="${WARNINGS}\n   - **ACTION REQUIRED**: Disable in Settings ‚Üí General ‚Üí Pull Requests ‚Üí 'Automatically delete head branches'"
            WARNINGS="${WARNINGS}\n   - Workflows use --delete-branch flag for explicit control"
            VALIDATION_FAILED=1
          fi

          # Warning: Check default branch
          if [ "$DEFAULT_BRANCH" != "main" ]; then
            WARNINGS="${WARNINGS}\n‚ö†Ô∏è Default branch is '$DEFAULT_BRANCH' (expected 'main')"
            WARNINGS="${WARNINGS}\n   - Workflows are configured for 'main' branch"
            WARNINGS="${WARNINGS}\n   - Update workflow files if using a different default branch"
          fi

          if [ $VALIDATION_FAILED -eq 1 ]; then
            echo "validation_status=failed" >> $GITHUB_OUTPUT
            echo -e "$WARNINGS"
          else
            echo "validation_status=passed" >> $GITHUB_OUTPUT
            echo "‚úÖ All configuration checks passed"
          fi

          # Store warnings for issue creation
          echo "VALIDATION_WARNINGS<<EOF" >> $GITHUB_ENV
          echo -e "$WARNINGS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create issue for configuration problems
        if: steps.validate.outputs.validation_status == 'failed'
        uses: actions/github-script@v8
        with:
          script: |
            const warnings = process.env.VALIDATION_WARNINGS;

            // Check if an open issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'configuration,validation'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('Repository Configuration Validation Failed')
            );

            const issueBody = `## Repository Configuration Validation Failed

${warnings}

## How to Fix

1. Navigate to Settings ‚Üí General ‚Üí Pull Requests
2. **UNCHECK** "Automatically delete head branches"
3. Save changes
4. Re-run this workflow to verify: Actions ‚Üí Validate Repository Configuration ‚Üí Run workflow

## Why This Matters

The Claude Code web interface tracks PR sessions through branch lifecycle:
- With auto-delete ON: Sessions show "Session ended" (branches deleted immediately)
- With auto-delete OFF: Sessions show "Merged" with proper status tracking

Our workflows use \`--delete-branch\` flags for explicit branch cleanup control.

## Additional Resources

- [REPOSITORY_SETTINGS_CHECKLIST.md](./REPOSITORY_SETTINGS_CHECKLIST.md)
- [LESSONS-LEARNED.md](./LESSONS-LEARNED.md)

---
ü§ñ Auto-generated by validate-config.yml workflow
`;

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## Configuration Validation Re-run\n\n${issueBody}`
              });

              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '‚ö†Ô∏è Repository Configuration Validation Failed',
                body: issueBody,
                labels: ['configuration', 'validation', 'priority:high']
              });

              console.log(`Created new issue #${newIssue.data.number}`);
            }

      - name: Report success
        if: steps.validate.outputs.validation_status == 'passed'
        run: |
          echo "‚úÖ Repository configuration is correct"
          echo "All Claude Code automation workflows are properly configured"
